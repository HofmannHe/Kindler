services:
  portainer:
    image: portainer/portainer-ce:${PORTAINER_VERSION:-2.33.2-alpine}
    container_name: portainer-ce
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - portainer_secrets:/run/secrets:ro
    command: ["--admin-password-file", "/run/secrets/portainer_admin", "--trusted-origins", "portainer.devops.192.168.51.30.sslip.io"]
    networks:
      infrastructure:
      management:
        ipv4_address: ${PORTAINER_FIXED_IP:-10.100.255.101}

  haproxy:
    image: haproxy:${HAPROXY_VERSION:-3.2.6-alpine3.22}
    container_name: haproxy-gw
    restart: unless-stopped
    ports:
      - "${HAPROXY_HTTP_PORT:-80}:80"
      - "${HAPROXY_HTTPS_PORT:-443}:443"
      - "8000:8000"  # Edge Agent WebSocket
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./ssl:/usr/local/etc/haproxy/certs:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      infrastructure:
      management:
        ipv4_address: ${HAPROXY_FIXED_IP:-10.100.255.100}
    # 注意：HAProxy 通过 docker network connect 动态连接到各集群网络

networks:
  infrastructure:
    name: infrastructure
  management:
    name: management
    driver: bridge
    ipam:
      config:
        - subnet: ${MANAGEMENT_SUBNET:-10.100.255.0/24}
          gateway: ${MANAGEMENT_GATEWAY:-10.100.255.1}

volumes:
  portainer_data:
  portainer_secrets:
    external: true
  haproxy_certs:
