services:
  portainer:
    image: portainer/portainer-ce:${PORTAINER_VERSION:-2.33.2-alpine}
    container_name: portainer-ce
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - portainer_secrets:/run/secrets:ro
    command: ["--admin-password-file", "/run/secrets/portainer_admin", "--trusted-origins", "portainer.devops.192.168.51.30.sslip.io"]
    networks:
      infrastructure:
      k3d-shared:

  haproxy:
    image: haproxy:${HAPROXY_VERSION:-3.2.6-alpine3.22}
    container_name: haproxy-gw
    restart: unless-stopped
    ports:
      - "${HAPROXY_HTTP_PORT:-80}:80"
      - "${HAPROXY_HTTPS_PORT:-443}:443"
      - "8000:8000"  # Edge Agent WebSocket
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./ssl:/usr/local/etc/haproxy/certs:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      infrastructure:
      k3d-shared:
    # 注意：HAProxy 通过 docker network connect 动态连接到各集群网络

networks:
  infrastructure:
    name: infrastructure
  k3d-shared:
    name: k3d-shared
    external: true

volumes:
  portainer_data:
  portainer_secrets:
    external: true
  haproxy_certs:
