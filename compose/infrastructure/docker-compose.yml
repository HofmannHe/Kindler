services:
  portainer:
    image: portainer/portainer-ce:${PORTAINER_VERSION:-2.33.2-alpine}
    container_name: portainer-ce
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - portainer_secrets:/run/secrets:ro
    command: ["--admin-password-file", "/run/secrets/portainer_admin"]
    networks:
      - infrastructure

  haproxy:
    image: haproxy:${HAPROXY_VERSION:-3.2.6-alpine3.22}
    container_name: haproxy-gw
    restart: unless-stopped
    ports:
      - "${HAPROXY_HTTP_PORT:-80}:80"
      - "${HAPROXY_HTTPS_PORT:-443}:443"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - haproxy_certs:/usr/local/etc/haproxy/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - infrastructure

  gitea:
    image: gitea/gitea:${GITEA_VERSION:-1.22-rootless}
    container_name: gitea
    restart: unless-stopped
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__server__DOMAIN=${HAPROXY_HOST:-192.168.51.30}
      - GITEA__server__ROOT_URL=http://git.devops.${BASE_DOMAIN:-192.168.51.30.sslip.io}/
      - GITEA__server__HTTP_PORT=3000
    volumes:
      - gitea_data:/var/lib/gitea
      - gitea_config:/etc/gitea
    networks:
      - infrastructure

networks:
  infrastructure:
    name: infrastructure

volumes:
  portainer_data:
  portainer_secrets:
    external: true
  haproxy_certs:
  gitea_data:
  gitea_config:
