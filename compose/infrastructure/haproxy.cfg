global
  daemon
  maxconn 2048

defaults
  mode http
  timeout connect 5s
  timeout client  30s
  timeout server  30s
  timeout tunnel  3600s  # WebSocket 连接超时

frontend fe_http
  bind *:80
  mode http
  # ACL definitions
  acl host_kindler  hdr_reg(host) -i ^kindler\.devops\.[^:]+
  acl host_git  hdr_reg(host) -i ^git\.devops\.[^:]+
  acl host_portainer  hdr_reg(host) -i ^portainer\.devops\.[^:]+
  acl host_kindler  hdr_reg(host) -i ^kindler\.devops\.[^:]+
  acl is_edge_agent path_beg /api/endpoints/ /api/edge/
  acl is_edge_agent_no_host path_beg /api/endpoints/ /api/edge/
  acl host_haproxy_stats  hdr_reg(host) -i ^haproxy\.devops\.[^:]+
  acl path_haproxy_stats path_beg /stat
  acl host_argocd hdr_reg(host) -i ^argocd\.devops\.[^:]+
  # BEGIN DYNAMIC ACL (managed by scripts/haproxy_route.sh)
  acl host_test4  hdr_reg(host) -i ^[^.]+\.test4\.[^:]+
  use_backend be_test4 if host_test4
  acl host_test3  hdr_reg(host) -i ^[^.]+\.test3\.[^:]+
  use_backend be_test3 if host_test3
  acl host_test-con2  hdr_reg(host) -i ^[^.]+\.test-con2\.[^:]+
  use_backend be_test-con2 if host_test-con2
  acl host_test-con1  hdr_reg(host) -i ^[^.]+\.test-con1\.[^:]+
  use_backend be_test-con1 if host_test-con1
  acl host_test1  hdr_reg(host) -i ^[^.]+\.test1\.[^:]+
  use_backend be_test1 if host_test1
  acl host_test  hdr_reg(host) -i ^[^.]+\.test\.[^:]+
  use_backend be_test if host_test
  acl host_dev-kind  hdr_reg(host) -i ^[^.]+\.dev-kind\.[^:]+
  use_backend be_dev-kind if host_dev-kind
  acl host_prod-kind  hdr_reg(host) -i ^[^.]+\.prod-kind\.[^:]+
  use_backend be_prod-kind if host_prod-kind
  acl host_uat-kind  hdr_reg(host) -i ^[^.]+\.uat-kind\.[^:]+
  use_backend be_uat-kind if host_uat-kind
  acl host_prod  hdr_reg(host) -i ^[^.]+\.prod\.[^:]+
  use_backend be_prod if host_prod
  acl host_uat  hdr_reg(host) -i ^[^.]+\.uat\.[^:]+
  use_backend be_uat if host_uat
  acl host_dev  hdr_reg(host) -i ^[^.]+\.dev\.[^:]+
  use_backend be_dev if host_dev
  # (intentionally no generic devops ACL; devops hosts route via explicit rules below)
  # END DYNAMIC ACL
  # HTTP request processing rules (must come before use_backend)
  http-request redirect scheme https code 301 if host_portainer !is_edge_agent
  # Backend routing
  use_backend be_kindler if host_kindler
  use_backend be_git if host_git
  use_backend be_portainer if host_portainer is_edge_agent
  use_backend be_portainer if is_edge_agent_no_host
  use_backend be_kindler if host_kindler
  use_backend be_haproxy_stats if host_haproxy_stats path_haproxy_stats
  use_backend be_argocd if host_argocd
  # BEGIN DYNAMIC USE_BACKEND (managed by scripts/haproxy_route.sh)
  # END DYNAMIC USE_BACKEND
  default_backend be_default_404

# WebSocket 专用 frontend（端口 8000）
frontend fe_websocket
  bind *:8000
  mode http
  timeout client 3600s
  # 将所有 8000 端口的请求转发到 Portainer 的 8000 端口
  default_backend be_portainer_websocket

frontend fe_https
  bind *:443 ssl crt /usr/local/etc/haproxy/certs/haproxy.pem
  mode http
  acl host_kindler  hdr_reg(host) -i ^kindler\.devops\.[^:]+
  acl host_git  hdr_reg(host) -i ^git\.devops\.[^:]+
  acl host_portainer  hdr_reg(host) -i ^portainer\.devops\.[^:]+
  acl host_kindler  hdr_reg(host) -i ^kindler\.devops\.[^:]+
  acl host_haproxy_stats  hdr_reg(host) -i ^haproxy\.devops\.[^:]+
  acl path_haproxy_stats path_beg /stat
  acl host_argocd hdr_reg(host) -i ^argocd\.devops\.[^:]+
  # BEGIN DYNAMIC ACL (managed by scripts/haproxy_route.sh)
  acl host_test4  hdr_reg(host) -i ^[^.]+\.test4\.[^:]+
  use_backend be_test4 if host_test4
  acl host_test3  hdr_reg(host) -i ^[^.]+\.test3\.[^:]+
  use_backend be_test3 if host_test3
  acl host_test-con2  hdr_reg(host) -i ^[^.]+\.test-con2\.[^:]+
  use_backend be_test-con2 if host_test-con2
  acl host_test-con1  hdr_reg(host) -i ^[^.]+\.test-con1\.[^:]+
  use_backend be_test-con1 if host_test-con1
  acl host_test1  hdr_reg(host) -i ^[^.]+\.test1\.[^:]+
  use_backend be_test1 if host_test1
  acl host_test  hdr_reg(host) -i ^[^.]+\.test\.[^:]+
  use_backend be_test if host_test
  acl host_dev-kind  hdr_reg(host) -i ^[^.]+\.dev-kind\.[^:]+
  use_backend be_dev-kind if host_dev-kind
  acl host_prod-kind  hdr_reg(host) -i ^[^.]+\.prod-kind\.[^:]+
  use_backend be_prod-kind if host_prod-kind
  acl host_uat-kind  hdr_reg(host) -i ^[^.]+\.uat-kind\.[^:]+
  use_backend be_uat-kind if host_uat-kind
  acl host_prod  hdr_reg(host) -i ^[^.]+\.prod\.[^:]+
  use_backend be_prod if host_prod
  acl host_uat  hdr_reg(host) -i ^[^.]+\.uat\.[^:]+
  use_backend be_uat if host_uat
  acl host_dev  hdr_reg(host) -i ^[^.]+\.dev\.[^:]+
  use_backend be_dev if host_dev
  # (intentionally no generic devops ACL; devops hosts route via explicit rules below)
  # END DYNAMIC ACL
  use_backend be_kindler if host_kindler
  use_backend be_git if host_git
  use_backend be_portainer if host_portainer
  use_backend be_kindler if host_kindler
  use_backend be_haproxy_stats if host_haproxy_stats path_haproxy_stats
  use_backend be_argocd if host_argocd
  # BEGIN DYNAMIC USE_BACKEND (managed by scripts/haproxy_route.sh)
  # END DYNAMIC USE_BACKEND
  default_backend be_default_404

backend be_kindler
  mode http
  server s1 kindler-webui-frontend:80 check

backend be_portainer
  mode http
  server s1 portainer-ce:9000

# Portainer WebSocket backend（端口 8000）
backend be_portainer_websocket
  mode http
  timeout server 3600s
  server s1 portainer-ce:8000

backend be_argocd
  server s1 172.18.0.6:30800

backend be_git
  mode http
  # Route Git traffic to host GitLab (IP:port mapping via HAProxy)
  server s1 192.168.51.30:6080

backend be_haproxy_stats
  mode http
  stats enable
  stats uri /stat
  stats refresh 10s

# Default 404 backend for unknown domains
backend be_default_404
  mode http
  errorfile 503 /dev/null
  http-request return status 404 content-type "text/plain" string "404 Not Found - Domain not configured in HAProxy"

# BEGIN DYNAMIC BACKENDS (managed by scripts/haproxy_route.sh)
backend be_test4
  server s1 172.21.0.8:30080
backend be_test3
  server s1 172.18.0.12:30080
backend be_test-con2
  server s1 172.21.0.7:30080
backend be_test-con1
  server s1 172.18.0.10:30080
backend be_test1
  server s1 172.21.0.6:30080
backend be_test
  server s1 172.18.0.8:30080
backend be_dev-kind
  server s1 172.21.0.2:30080
backend be_prod-kind
  server s1 172.21.0.4:30080
backend be_uat-kind
  server s1 172.21.0.3:30080
backend be_prod
  server s1 10.103.0.2:30080
backend be_uat
  server s1 10.102.0.2:30080
backend be_dev
  server s1 10.101.0.2:30080
  # (no be_devops backend; argocd/devops routes use dedicated backends)
