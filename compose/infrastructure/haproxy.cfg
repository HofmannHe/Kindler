global
  daemon
  maxconn 2048

defaults
  mode http
  timeout connect 5s
  timeout client  30s
  timeout server  30s

# Frontend for Kubernetes NodePort HTTP ingress routing via host-based ACLs
frontend fe_kube_http
  bind *:23080
  # BEGIN DYNAMIC ACL (managed by scripts/haproxy_route.sh)
  acl host_devops  hdr_reg(host) -i ^devops\.[^:]+
  use_backend be_devops if host_devops
  acl host_test-k3d-fixed  hdr_reg(host) -i ^test-k3d-fixed\.[^:]+
  use_backend be_test-k3d-fixed if host_test-k3d-fixed
  acl host_test-final  hdr_reg(host) -i ^test-final\.[^:]+
  use_backend be_test-final if host_test-final
  acl host_debug-k3d  hdr_reg(host) -i ^debug-k3d\.[^:]+
  use_backend be_debug-k3d if host_debug-k3d
  acl host_prod-k3d  hdr_reg(host) -i ^prod-k3d\.[^:]+
  use_backend be_prod-k3d if host_prod-k3d
  acl host_uat-k3d  hdr_reg(host) -i ^uat-k3d\.[^:]+
  use_backend be_uat-k3d if host_uat-k3d
  acl host_dev-k3d  hdr_reg(host) -i ^dev-k3d\.[^:]+
  use_backend be_dev-k3d if host_dev-k3d
  acl host_prod  hdr_reg(host) -i ^prod\.[^:]+
  use_backend be_prod if host_prod
  acl host_uat  hdr_reg(host) -i ^uat\.[^:]+
  use_backend be_uat if host_uat
  acl host_dev  hdr_reg(host) -i ^dev\.[^:]+
  use_backend be_dev if host_dev
  # END DYNAMIC ACL
  default_backend be_default_404

## dynamic backends
# BEGIN DYNAMIC BACKENDS (managed by scripts/haproxy_route.sh)
backend be_devops
  server s1 10.10.2.2:80
backend be_test-k3d-fixed
  server s1 127.0.0.1:30080
backend be_test-final
  server s1 127.0.0.1:30080
backend be_debug-k3d
  server s1 127.0.0.1:30080
backend be_prod-k3d
  server s1 10.10.7.2:80
backend be_uat-k3d
  server s1 10.10.6.2:80
backend be_dev-k3d
  server s1 10.10.5.2:80
backend be_prod
  server s1 127.0.0.1:30080
backend be_uat
  server s1 127.0.0.1:30080
backend be_dev
  server s1 127.0.0.1:30080

backend be_default_404
  http-request return status 404 content-type text/plain lf-string "not found"
