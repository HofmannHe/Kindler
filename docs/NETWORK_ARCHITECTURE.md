# 网络架构规划

## 当前问题分析

### 问题 1: Edge Agent 无法访问 HAProxy 固定 IP
- Edge Agent 运行在 k3d 集群的 Pod 网络（10.42.0.0/16）
- HAProxy 固定 IP (10.100.255.100) 在 management 网络中
- Pod 网络无法路由到 management 网络

### 问题 2: 网络隔离需求
- 业务集群之间需要独立（最好隔离）
- 所有业务集群都需要访问 devops、Portainer、HAProxy

## 方案对比

### 方案 A: 宿主机 IP 统一入口（推荐）

**架构**:
```
业务集群 Pod 网络 (10.42.0.0/16)
    ↓
宿主机网络接口 (192.168.51.30)
    ↓
HAProxy (端口 80/443/8000)
    ↓
Portainer (management 网络 10.100.255.101)
```

**优点**:
- 简单可靠，使用宿主机 IP 作为统一入口
- Pod 可以直接访问宿主机 IP
- 业务集群之间完全隔离

**配置**:
- Edge Agent URL: `http://192.168.51.30:80` (宿主机 IP)
- HAProxy 监听: `0.0.0.0:80/443/8000`
- Portainer 固定 IP: `10.100.255.101` (management 网络)

### 方案 B: 网络桥接（复杂）

**架构**:
```
业务集群网络 (10.100.X.0/24)
    ↓
HAProxy 在集群网络中的 IP (10.100.X.4)
    ↓
Portainer (management 网络 10.100.255.101)
```

**优点**:
- 内网通信，不经过宿主机
- 可实现业务集群独立（但不隔离）

**缺点**:
- HAProxy/Portainer 需要连接所有集群网络
- IP 地址不固定（每个网络都不同）
- 复杂度高，维护困难

### 方案 C: 混合方案（最佳）

**架构**:
```
┌─────────────────────────────────────────────────────────┐
│ 宿主机 (192.168.51.30)                                  │
│                                                          │
│  HAProxy (端口映射 80/443/8000)                          │
│     ↓                                                    │
│  Portainer (management 网络 10.100.255.101)              │
│     ↓                                                    │
│  devops 集群 (k3d-devops, 10.100.10.0/24)               │
└─────────────────────────────────────────────────────────┘
         ↑                    ↑                    ↑
         │                    │                    │
  ┌──────┴─────┐       ┌─────┴──────┐      ┌─────┴──────┐
  │ dev-k3d    │       │ uat-k3d    │      │ prod-k3d   │
  │ (独立网络)  │       │ (独立网络)  │      │ (独立网络)  │
  │10.100.50.0 │       │10.100.60.0 │      │10.100.70.0 │
  └────────────┘       └────────────┘      └────────────┘
```

**特点**:
1. **业务集群隔离**: 每个集群使用独立子网，彼此无法直接通信
2. **统一入口**: 所有集群通过宿主机 IP 访问核心服务
3. **固定 IP**: HAProxy 和 Portainer 在 management 网络中有固定 IP
4. **简单可靠**: Edge Agent 使用 `192.168.51.30:80` 访问 Portainer

**网络配置**:
- management 网络: 10.100.255.0/24
  - HAProxy: 10.100.255.100 (仅内部使用，不暴露给集群)
  - Portainer: 10.100.255.101 (仅内部使用)
- devops 集群: 10.100.10.0/24 (连接 HAProxy 用于域名路由)
- 业务集群: 10.100.50+.0/24 (独立，不互连)
- 宿主机 IP: 192.168.51.30 (统一外部入口)

**Edge Agent 配置**:
- URL: `http://192.168.51.30:80` (通过 HAProxy 转发到 Portainer)
- WebSocket: `192.168.51.30:8000`

**HAProxy 后端**:
- Portainer: `10.100.255.101:9000` (通过 management 网络)
- devops 集群: `10.100.10.2:30800` (通过连接到 k3d-devops 网络)

## 推荐方案: 方案 C

### 实现步骤

1. **配置 HAProxy**:
   - 在 management 网络中有固定 IP (10.100.255.101)
   - 暴露端口到宿主机 (80/443/8000)
   - 后端使用 Portainer 固定 IP

2. **配置 Portainer**:
   - 在 management 网络中有固定 IP (10.100.255.101)
   - 仅需连接 infrastructure 和 management 网络
   - **不需要**连接业务集群网络

3. **配置 Edge Agent**:
   - URL: 使用 `HAPROXY_HOST` (192.168.51.30)
   - 通过宿主机端口访问 HAProxy

4. **集群网络连接**:
   - HAProxy 连接 k3d-devops 网络（用于 ArgoCD 等服务路由）
   - HAProxy **不连接**业务集群网络（保持隔离）
   - 业务集群通过宿主机 IP 访问核心服务

### 配置变更

- `HAPROXY_FIXED_IP=10.100.255.100` (仅内部使用)
- `PORTAINER_FIXED_IP=10.100.255.101` (仅内部使用)
- `HAPROXY_HOST=192.168.51.30` (集群访问核心服务的统一入口)

### 优势

1. **业务集群完全隔离**: 独立子网，无网络连接
2. **统一管理**: 所有集群通过宿主机 IP 访问
3. **配置简单**: 不需要动态网络连接
4. **可维护性高**: 网络拓扑清晰，易于理解
5. **性能开销小**: 宿主机端口转发性能优异

## 验证清单

- [ ] HAProxy 可通过 192.168.51.30:80 访问
- [ ] Portainer 可通过 192.168.51.30:80 访问（经 HAProxy 转发）
- [ ] Edge Agent 成功连接（EdgeID 不为空）
- [ ] 业务集群之间无法直接通信（网络隔离）
- [ ] 所有集群都可访问 devops 集群服务

